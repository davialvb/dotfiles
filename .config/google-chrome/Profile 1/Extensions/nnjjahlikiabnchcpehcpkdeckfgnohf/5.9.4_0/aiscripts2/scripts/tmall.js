function aiparser(e){if(top==self){var t=0;chrome.runtime.sendMessage({cmd:"SET_GROUPS",groups:["主图","视频","SKU图片","详情"]});var n=document.querySelectorAll("#J_UlThumb img"),a=document.querySelectorAll(".J_TSaleProp a"),r=document.querySelectorAll("#description img");if(location.href.match("detail.m")){var o=document.createElement("script");o.innerText="localStorage.fatkun_mkskip = JSON.stringify({\n            videos: window._DATA_Mdskip.item.videos\n        });",document.body.appendChild(o);var i=JSON.parse(localStorage.fatkun_mkskip);i.videos&&i.videos.length>0&&(new VItem({type:"VIDEO",src:i.videos[0].url,group:"视频",groupIndex:1,alt:"视频"},t++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",tabId:_tabInfo.id,item:e})}),b({type:"VIDEO",src:i.videos[0].videoThumbnailURL,group:"视频",groupIndex:1,alt:"视频封面"})),n=document.querySelectorAll(".preview-slider img, .pic-gallery-wrapper img"),r=document.querySelectorAll("#modules-desc img, #detailDesc img"),(l=(l=document.querySelector("a.app-video"))?l.dataset.video:"")&&new VItem({src:l,group:"视频",groupIndex:1},t++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",tabId:_tabInfo.id,item:e})})}var d=1;n.forEach(function(e,t){b({src:e.src,alt:"主图-"+w(d++,2),group:"主图",groupIndex:0})});var c=1;a.forEach(function(e,t){var n=e.style.backgroundImage.match(/(\/\/.*)"/);n&&b({src:n=n=location.protocol+n[1],group:"SKU图片",groupIndex:2,alt:"SKU-"+w(c++,2)+"-"+$(e).parent().attr("title")})});var s=1;r.forEach(function(e,t){var n=e.dataset.src||e.dataset.ksLazyload||e.src;n.match("img-tmdetail.alicdn.com/tps/i3/T1BYd_XwFcXXb9RTPq-90-90.png")||n.match("spaceball.gif")||b({alt:"详情-"+w(s++,2),src:n,group:"详情",groupIndex:3})});for(var m=document.querySelectorAll("script"),u=0;u<m.length;u++)if(m[u].innerText){if(imgVedioID=m[u].innerText.match(/"imgVedioID":"(\d+)"/),imgVedioID&&(imgVedioID=imgVedioID[1],userId=m[u].innerText.match(/"userId":"(\d+)"/),userId=userId?userId[1]:"",imgVedioID&&userId)){var l="https://cloud.video.taobao.com/play/u/"+userId+"/p/1/e/6/t/1/"+imgVedioID+".mp4";new VItem({src:l,group:"视频",groupIndex:1,alt:"视频"},t++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",tabId:_tabInfo.id,item:e})})}var p=m[u].innerText.match(/"httpsDescUrl".*?"(.*?)"/);p&&0==r.length&&(p=p[1],fetch(p).then(e=>e.text()).then(e=>{e.match(/<img.*?>/g).forEach(e=>{var t=e.match('src="(.*?)"')[1];t=t.replace(/^\/\//,"https://"),b({alt:"详情-"+w(s++,2),src:t,group:"详情",groupIndex:3})})}));var f=m[u].innerText.match(/"valFlashUrl".*?"(.*?)"/);if(f){var g=f[1].replace(/(\/\/cloud\.video\.taobao\.com\/play\/u\/\d+\/p\/\d+\/e\/)\d+(\/t\/)\d+(.+)swf/,"$16$21$3mp4");(g=g.replace(/^\/\//,"https://")).indexOf(".mp4")>0&&new VItem({src:g,group:"视频",alt:"详情视频",groupIndex:1,alt:"视频"},t++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",tabId:_tabInfo.id,item:e})})}var I=m[u].innerText.match(/({"valItemInfo":[\s\S]*?)\);/);if(I)try{for(var h in(I=JSON.parse(I[1])).propertyPics)for(var v=0;v<I.valItemInfo.skuList.length;v++)if(I.valItemInfo.skuList[v].pvs.indexOf(h.replace(/^;/,"").replace(/;$/,""))>=0){b({src:I.propertyPics[h][0],group:"SKU图片",groupIndex:2,alt:"SKU-"+w(c++,2)+"-"+I.valItemInfo.skuList[v].names});break}}catch(e){}}}function w(e,t){return(Array(t).join(0)+e).slice(-t)}function b(e){e.src.match("^//")&&(e.src=`https:${e.src}`),e.alt&&(e.alt=`${e.alt}`),new ParsedPItem(e,t++,_tabInfo,function(e){e.width>100&&chrome.runtime.sendMessage({cmd:"ADD_IMG",tabId:_tabInfo.id,item:e})})}}!function(){window.ftk_docTitle=document.title.replace("-tmall.com天猫","");var e=location.href.match(/\bid=(\d+)/);e&&(window.ftk_docTitle=`${e[1]}-${window.ftk_docTitle}`,window.ftk_itemId=e[1])}(),window.aiparser=aiparser,function(){var e,t,n,a,r,o,i=1,d=0,c=!1,s=!1;function m(){n=location.href.match("\\bid=(\\d+)")[1],a=location.href.match("chaoshi.detail")?document.querySelector('input[name="user_id"]').value:document.getElementsByName("microscope-data")[0].content.match(/userid=(\d+)/)[1];for(var i=document.querySelectorAll("script"),c=0;c<i.length;c++)if(r=i[c].innerText.match(/"spuId":"(\d+)"/)){r=r[1];break}o=`jsonp${parseInt(1e4*Math.random())}`;var m=document.createElement("script");m.innerText=`\n        window.${o} = function(data){\n            window.postMessage({\n                topic: 'fatkun-tbview',\n                data: data\n            }, '*')\n        };\n        localStorage.fatkun_ua = window.getUA();\n    `,document.body.append(m),window.addEventListener("message",function(n){"fatkun-tbview"==n.data.topic&&function(n){if(n.rateDetail){var a=n.rateDetail.paginator.page;n.rateDetail.rateList.forEach((e,t)=>{!function e(t,n,a){var r=`第${a}页-第${n+1}条评论 <${t.auctionSku}>`;t.pics.forEach((e,o)=>{new ParsedPItem({src:u(e),alt:`${a}-${n+1}-${t.id}-图片-${o+1}`,group:r,groupIndex:20*(a-1)+n},d++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_IMG",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})})});t.videoList.forEach((e,o)=>{new VItem({src:u(e.cloudVideoUrl),group:r,alt:`${a}-${n+1}-${t.id}-${o+1}-视频`,groupIndex:20*(a-1)+n},d++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})}),new ParsedPItem({src:u(e.coverUrl),group:r,alt:`${a}-${n+1}-${t.id}-${o+1}-视频封面`,groupIndex:20*(a-1)+n},d++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_IMG",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})})});t.appendComment&&e(t.appendComment,n,a)}(e,t,a)})}(!t||e<t)&&(e++,s||setTimeout(l.bind(this,e),5e3));e!=t&&n.rateDetail.paginator.page!=n.rateDetail.paginator.lastPage||chrome.runtime.sendMessage({cmd:"COLLECT_COMPLETED"})}(n.data.data)})}function u(e){if(!e.match(/^http/))return location.protocol+e}function l(e){var t=document.createElement("script"),i=`${Date.now()}_${parseInt(1e4*Math.max(.1,Math.random()))}`;t.src=`https://rate.tmall.com/list_detail_rate.htm?itemId=${n}&spuId=${r}&sellerId=${a}&order=3&currentPage=${e}&append=0&content=1&tagId=&posi=&picture=1&groupId=&ua=${encodeURIComponent(localStorage.fatkun_ua)}&needFold=0&_ksTS=${i}&callback=${o}`,document.body.appendChild(t)}d=0;var p=0,f=setInterval(function(){p>20&&clearInterval(f),p++,$('a[href="#J_Reviews"]').length>0&&0==$("#ftk-review-download-btn").length&&($(`<li class="item-desc-tabview-item" style="cursor: default;">\n                <button id="ftk-review-download-btn" style="cursor: pointer;">\n                    <img style="width:16px;vertical-align:middle;margin-right:4px;" src="${chrome.extension.getURL("/icon-small.png")}"/>\n                    <span>下载</span>\n                </button>\n                <span>第</span>\n                <input id="fatkun-review-page-input-from" type="number" value="1" style="width: 4em"/>\n                <span>到</span>\n                <input id="fatkun-review-page-input-to" type="number" value="10" style="width: 4em"/>\n                <span>页评论图片</span>\n            </li>`).insertAfter($('a[href="#J_Reviews"]').closest("li")).find("button").click(function(){i=document.getElementById("fatkun-review-page-input-from").value,i=parseInt(i),t=document.getElementById("fatkun-review-page-input-to").value,t=parseInt(t),g()}),clearInterval(f))},500);function g(){return c||(m(),c=!0),e=i,chrome.runtime.sendMessage({cmd:"OPEN-OUTPUT",type:"ftk-tb-review"},function(){setTimeout(function(){chrome.runtime.sendMessage({cmd:"SUPPORT_COLLECT_PAUSE"}),l(e)},2e3)}),chrome.runtime.onMessage.addListener(function(t){"PAUSE_COLLECT"==t.cmd?s=!0:"RESUME_COLLECT"==t.cmd&&(s=!1,l(e))}),!1}window.extras={downloadMJX:function(){g()}}}();