var downloader=function(){function e(e){var t=e.bigUrl||e.originalUrl,n="jpg",a=e.alt,i=e.docTitle;a&&(a=a.replace(/\//g," "),a=utils.getSafeDir(a)),i&&(i=i.replace(/\//g," "),i=utils.getSafeDir(i));var l=t.lastIndexOf("/"),o=t.substr(l+1,t.length);(l=o.lastIndexOf("?"))>=0&&(o=o.substr(0,l)),(l=o.lastIndexOf("."))>=0&&(n=o.substr(l+1,o.length),o=o.substr(0,l));o=o+"."+(n=("jpeg"==e.ext?"jpg":e.ext)||n);"original"!=r.filenameAltOrOriginal&&e.group&&(o=e.group+"-"+o),a&&"alt"==r.filenameAltOrOriginal&&(o=a+"."+n),o.lastIndexOf(".")<0&&(o+=".jpg");var s=o;try{s=decodeURIComponent(o)}catch(e){}var u=(s=(s=(s=s.replace(/^ +/,"")).replace(/ +$/,"")).replace(/ /g,"_yythkg_")).replace(/[/~|\\:*?"'<>=%$@#+;,!\^\s]/g,"_").replace(/\.+$/g,"").split(".");u[0]=utils.getSafeDir(u[0].substr(0,100)),u=u.join("."),r.needRename&&(u=utils.replaceVarible({text:r.renameRule||r.defaultConfig.renameRule,index:e.selected?e.selectIndex:e.showIndex,ext:n,name:u,pageTitle:i}));var d=u;return"FIXED"==r.dirType?r.fixedDir&&(d=utils.getSafeDir(r.fixedDir)+"/"+u):i&&(d=i+"/"+u),d=d.replace(/_yythkg_/g," ")}function t(t){if(t){var n=t.bigUrl,a=t.blobUrl,l=e(t),o=a||n;r.autoConvertWebp&&t.jpgPngDataUrl&&(o=t.jpgPngDataUrl),"VIDEO"==t.type&&(o=t.originalUrl),chrome.downloads.download({url:o,filename:l,saveAs:!1,conflictAction:"uniquify"},function(r){if(r&&(i[r]=t),!r&&chrome.runtime.lastError&&chrome.runtime.lastError.message.match("Invalid filename")){var a=t.ref;a&&(a=(a=a.replace(/.*?:\/\//,"")).replace(/\?.*/,"")),a.match("/$")||(a+="/");var l=e({bigUrl:t.bigUrl,alt:t.showIndex+1+""});chrome.downloads.download({url:n,filename:a+l,saveAs:!1,conflictAction:"uniquify"},function(e){i[e]=t})}})}}chrome.downloads.onChanged.addListener(function(e){if(e.state&&r.limitConcurrent&&e.state.current.match("complete|interrupted")){var o=i[e.id];if(o&&(n(e.state.current,o),l<a.length)){var s=a[l];"started"!=downloader.status&&"resumed"!=downloader.status||(l++,t(s))}}});var r,n,a=[],i=[],l=0;return{status:"not-inited",init:function(e,t){r=e,n=t,l=0},download:function(e){a=e,l=0,a=e;for(var n=r.limitConcurrent||10,i=0;i<n&&i<a.length;i++)l++,t(a[i]);this.status="started"},downloadSingle:function(e){t(e)},stop:function(){this.status="stoped"},pause:function(){this.status="paused"},resume:function(){this.status="resumed";for(var e=0;e<r.limitConcurrent&&l<a.length;e++)t(a[l++])}}}();