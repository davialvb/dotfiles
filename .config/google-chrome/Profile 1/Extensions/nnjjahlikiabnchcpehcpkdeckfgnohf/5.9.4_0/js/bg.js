var aiscripts2=[];function insertCt(e,t,n){var o=!!navigator.userAgent.match("MetaSr");["lib/jQuery.js","lib/dom-to-image.min.js","js/utils.js","js/parsers.js","js/tj.js","js/config.js","js/appConfig.js","js/sites.js","js/item.js","js/dragdownload.js","js/bigImgParser.js"].forEach(function(n){chrome.tabs.executeScript(e.id,o?{file:n}:{file:n,frameId:t||0})}),chrome.tabs.executeScript(e.id,o?{file:"js/ct.js"}:{file:"js/ct.js",frameId:t||0},function(){n&&n(e,t||0)}),chrome.tabs.insertCSS(e.id,o?{file:"css/ct.css"}:{file:"css/ct.css",frameId:t||0}),chrome.tabs.insertCSS(e.id,o?{file:"css/droppanel.css"}:{file:"css/droppanel.css",allFrames:!0}),t||aiscripts.init(function(){})}function showAiScriptMsg(e,t){chrome.tabs.executeScript(e,{file:"lib/vue.min.js"}),chrome.tabs.executeScript(e,{file:"lib/vue-element/index.js"}),chrome.tabs.insertCSS(e,{file:"lib/vue-element/index.css"}),chrome.tabs.executeScript(e,{file:"messages/aiscriptMsg.js"},function(){chrome.tabs.executeScript(e,{code:"showAiScriptMsg("+JSON.stringify(t)+")"})})}function initAdvanceMode(){var e=[],t=[];function n(n){n.url;var o=n.tabId;-1!=o&&-1!=t.indexOf(o)&&e.push({src:n.url,tabId:o})}function o(t){chrome.tabs.query({},function(n){var o=n.map(function(e){return e.id}),s=[];e.forEach(function(e){o.indexOf(e.tabId)>=0&&-1==s.indexOf(e)&&s.push(e)}),t(s)})}function s(n,o,s){if(o&&o.url){t.push(s.id);var a=[];e.forEach(function(e){e.tabId!=n&&a.push(e)}),e=a}}return{status:"disabled",enable:function(){"disabled"==this.status&&(chrome.webRequest.onBeforeRequest.addListener(n,{urls:["<all_urls>"],types:["image"]}),chrome.tabs.onUpdated.addListener(s),this.status="enabled")},disable:function(){"enabled"==this.status&&(chrome.webRequest.onBeforeRequest.removeListener(n),chrome.tabs.onUpdated.removeListener(s),this.status="disabled")},getOneTabImages:function(e,t,n){var s=[];o(function(e){e.forEach(function(e,n){e.tabId==t&&s.push(e)}),n(s)})},getAllTabImages:function(e){o(function(e){var t=[];e.forEach(function(e,n){t.push(e)}),cb(t)})}}}chrome.runtime.onMessage.addListener(function(e,t,n){switch(e.cmd){case"INSERT_CT":insertCt(t.tab,t.frameId,n);break;case"ENABLE_AISCRIPT":aiscripts.enable(e.id,function(){chrome.tabs.reload(t.tab.id)});break;case"UPDATE_AISCRIPT":aiscripts.update(e.newItem,function(){chrome.tabs.reload(t.tab.id)})}return!0});var _config,advancedMode=initAdvanceMode();function main(e){function t(e){var t=e.map(function(e){return e.id});chrome.tabs.query({url:chrome.extension.getURL("output/output.html")},function(e){0==e.length?(localStorage.imageTabIds=JSON.stringify(t),chrome.tabs.create({url:chrome.extension.getURL("output/output.html")})):(localStorage.imageTabIds=JSON.stringify(JSON.parse(localStorage.imageTabIds||"[]").concat(t)),chrome.tabs.update(e[0].id,{active:!0}))})}function n(e){e.forEach(function(e){var t="output/output.html",n=[];n.push("tabId="+e.id),n.length>0&&(t+="?"+n.join("&")),chrome.tabs.create({url:t})})}function o(){chrome.tabs.query({active:!0,windowId:chrome.windows.WINDOW_ID_CURRENT},function(e){s(e[0])})}function s(o){e.singleOutput?t([o]):n([o])}_config=e,e.advancedMode&&advancedMode.enable(),downloader.init(e,function(e){}),chrome.runtime.onMessage.addListener(function(s,a,i){switch(s.cmd){case"GET_CURRENT_TAB_IMAGE":"popup"==s.from&&tj.send("dl",{tab:"one",from:"popup"}),o();break;case"GET_ALL_TAB_IMAGE":"popup"==s.from&&tj.send("dl",{tab:"all",from:"popup"}),chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT},function(o){e.singleOutput?t(o):n(o)});break;case"GET_ADVANCEC_IMGS":s.tabId?advancedMode.getOneTabImages(a.tab.id,s.tabId,i):advancedMode.getAllTabImages(a.tab.id,i);break;case"DOWNLOAD_BY_DRAG":"download-instantly"==e.dragDownloadMode?downloader.downloadSingle(s.item):(r=s.item,chrome.tabs.query({url:chrome.extension.getURL("/output/output.html?justopen=1&type=drag"),windowId:chrome.windows.WINDOW_ID_CURRENT},function(e){0==e.length?chrome.tabs.create({url:chrome.extension.getURL("/output/output.html?justopen=1&type=drag")},function(e){setTimeout(function(){chrome.tabs.sendMessage(e.id,{type:"drag",cmd:"ADD_IMG",item:r})},2e3)}):chrome.tabs.sendMessage(e[0].id,{type:"drag",cmd:"ADD_IMG",item:r})}));break;case"SWITCH_CONTEXTMENU":switchContextmenu();break;case"OPEN-OUTPUT":!function(e,t,n){var o=chrome.extension.getURL("/output/output.html?justopen=1&type="+e+"&tabId="+(n||""));chrome.tabs.query({url:o,windowId:chrome.windows.WINDOW_ID_CURRENT},function(e){e.length>0?(chrome.tabs.update(e[0].id,{active:!0}),t()):chrome.tabs.create({url:o},function(){t()})})}(s.type,i,a.tab.id)}var r;return!0});var a={batchDownload:{id:-1,options:{title:utils.getI18n("batchDownload"),type:"normal",contexts:["all"],onclick:function(e,t){s(t),tj.send("dl",{tab:"one",from:"contextmenu"})}}},ocrTable:{id:-1,options:{title:utils.getI18n("ocrTable"),type:"normal",contexts:["image"],onclick:function(e,t){chrome.tabs.create({url:`/ocr/index.html?type=${OCR_TYPE_ALI_TABLE}&imageUrl=${encodeURIComponent(e.srcUrl)}`})}}},ocrGeneral:{id:-1,options:{title:utils.getI18n("ocrGeneral"),type:"normal",contexts:["image"],onclick:function(e,t){chrome.tabs.create({url:`/ocr/index.html?type=${OCR_TYPE_ALI_GENERAL}&imageUrl=${encodeURIComponent(e.srcUrl)}`})}}}};!function(){function t(e){for(var t in a)-1!=a[t].id&&chrome.contextMenus.remove(a[t].id);e.forEach(e=>{a[e].id=chrome.contextMenus.create(a[e].options)})}var n="";t(e.enabledMenus),chrome.storage.onChanged.addListener(function(e){var o=e.app_config;o&&(newConfigStr=JSON.stringify(o.newValue),o&&n!=newConfigStr&&(n=newConfigStr,t(o.newValue.enabledMenus)))})}(),tj.send("config",e),"no"==gConfig.popupMode?chrome.browserAction.onClicked.addListener(function(e){o()}):chrome.browserAction.setPopup({popup:"popup/popup.html"})}!function(){function e(e){e.advancedMode?advancedMode.enable():advancedMode.disable()}localStorage.defaultMessages?appConfig.init(main,e):fetch("/_locales/en/messages.json").then(e=>e.json()).then(t=>{localStorage.defaultMessages=JSON.stringify(t),appConfig.init(main,e)})}(),bigImgParser.init_(function(e){}),$.ajax({url:chrome.extension.getURL("dropPanel.html"),success:function(e){chrome.storage.local.set({dropPanelHtml:e})}});var domains=[];function setCrossDomainBg(){function e(e){for(var t=0;t<domains.length;t++)if(e.url.match(domains[t].requetUrlReg)){var n=e.responseHeaders.filter(e=>"access-control-allow-origin"!=e.name.toLowerCase());return n.push({name:"Access-Control-Allow-Origin",value:domains[t].domain}),{responseHeaders:n}}}try{chrome.webRequest.onHeadersReceived.addListener(e,{urls:["<all_urls>"]},["blocking","responseHeaders","extraHeaders"])}catch(t){chrome.webRequest.onHeadersReceived.addListener(e,{urls:["<all_urls>"]},["blocking","responseHeaders"])}}setCrossDomainBg(),function(){function e(e){let t=e.requestHeaders.filter(e=>e.name.match("^ftk-")),n=e.requestHeaders.filter(e=>!e.name.match("^ftk-"));return t.forEach(e=>{let t=e.name.substr(4).toLowerCase(),o=n.find(e=>e.name.toLowerCase()==t);o?o.value=e.value:(o={name:t,value:e.value},n.push(o))}),{requestHeaders:n}}try{chrome.webRequest.onBeforeSendHeaders.addListener(e,{urls:["<all_urls>"]},["blocking","requestHeaders","extraHeaders"])}catch(t){chrome.webRequest.onHeadersReceived.addListener(e,{urls:["<all_urls>"]},["blocking","requestHeaders"])}}(),chrome.runtime.onMessage.addListener(function(e,t,n){if("GET_STORAGE"==e.cmd)chrome.storage.local.get(e.key,function(t){n(utils.parseJSON(t[e.key]))});else if("SET_STORAGE"==e.cmd){var o={};o[e.key]=e.value,chrome.storage.local.set(o)}else"NET"==e.cmd?$.ajax($.extend({},e.settings,{success:function(e){n({status:"ok",data:e})},error:function(){n({status:"error"})}})):"SILENT_DOWNLOAD"==e.cmd?e.imgs.forEach(function(e){var t={url:e.url,saveAs:!1,conflictAction:"uniquify"};e.filename&&(t.filename=e.filename),chrome.downloads.download(t)}):"GET_COOKIE"==e.cmd?chrome.cookies.getAll(e.details,function(e){n(e)}):"GA"==e.cmd?_gaq.push(["_trackEvent",e.category,e.action,e.opt_label,null,!1]):"ADD_CROSS_DOMAIN"==e.cmd&&(domains.find(t=>t.requetUrlReg==e.domain.requetUrlReg)||domains.push(e.domain));return!0}),chrome.tabs.query({},function(e){e.forEach(function(e){chrome.tabs.sendMessage(e.id,{cmd:"CHECK_INIT_CT"},function(t){!chrome.runtime.lastError&&t||chrome.tabs.executeScript(e.id,{file:"js/initCt.js"},function(){})})})}),setTimeout(function(){tj.send("active")},5e3),function(){var e;function t(){$.ajax({url:gConfig.staticServer+"/aiscripts2/scripts.json?_="+Date.now(),dataType:"json",success:function(t){t.forEach(function(t,n){var o=_.find(e,{id:t.id});o&&o.text?(utils.compareVersion(t.version,o.version)>0&&(o.latestVersion=t.version,o.latest=t),aiscripts2.push(o)):aiscripts2.push(t)}),chrome.storage.local.set({aiscripts2:aiscripts2}),aiscripts.init(function(){aiscripts2.forEach(e=>{e.text?e.latest&&aiscripts.update(e.latest):aiscripts.enable(e.id,function(){})})})}})}chrome.storage.local.get("aiscripts2",function(n){0==(e=n.aiscripts2||[]).length?aiscripts.init_(function(n){e=n,t()}):t()})}();